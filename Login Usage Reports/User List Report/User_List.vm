<html>

## ======================================================================================================================
## Name: User_List.vm 
## 
## Description: Context Insensitive Report that can be exported to Excel, Word, PDF or HTML. 
##              It lists all the active users for the organization and for each user their Username, Full Name, Email, Groups,
##              and License Type. 
##            
##              *In order to get license data for the user, the user would need to have logged in within 6 months prior to 
##              the report being run. If the user has not logged in within the last 6 months then it will show
##              'No license usage last 6 months'
##          
##              
## ======================================================================================================================
## MODIFICATION HISTORY 
## 
## Date         Revision   Person             Comments 
## -----------  ---------  ----------------   ---------------------------------- 
## 2024-01-19   1.0        Anna FitzGerald    Initial Build
##
##                                                                                 
##
## ======================================================================================================================
##
## Report Criteria:
## ---------------------------    
##  * Note: If being used this criteria will need to be added to the report configuration.  
##
##      Type:       Display Name:           Report Global Variable:   Function:
##      -----------------------------------------------------------------------------------------------------------------
##      [None]
##
## ======================================================================================================================
## 
## Sources Utilized: 
## $userSource
##  
## Constants:
## --------------------------
##
## Timezone 
#set( $timeZone = "America/Los_Angeles" )

## Formatting
#if( $format == 'pdf' || $format == 'html')
	#set( $primaryFont = "Arimo")  	
#else 
	#set( $primaryFont = "Calibri")
#end

##
#########################################################################################################################
<head>
## .pdf & .html typeface link ##
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Arimo:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">

<style>
/* .doc & .xlsx @font-face rule */
@font-face
  {font-family:"Calibri";
  panose-1:2 15 5 2 2 2 4 3 2 4;
  mso-font-charset:0;
  mso-generic-font-family:swiss;
  mso-font-pitch:variable;
  mso-font-signature:-1610611985 1073750139 0 0 159 0;}
body {
	margin:auto;
	width:80%;
}
table {
	border-collapse:collapse;
}
tr {
	mso-height-source:auto;
	height:auto;
}
col {
	mso-width-source:auto;
}
br {
	mso-data-placement:same-cell;
}
td.title {
	font-size:13pt;
	font-weight:700;
	font-family:'$primaryFont',sans-serif;
}
td.header {
	white-space:normal;
	word-wrap:break-word;
	overflow-wrap:break-word;
	font-weight:700;
	font-size:11pt;
	font-family:'$primaryFont',sans-serif;
	background-color:#e6e6e6;
	border:.5pt solid #999999;
	vertical-align:middle;
	text-align:center;
}
td.cell {
	white-space:normal;
	word-wrap:break-word;
	overflow-wrap:break-word;
	font-weight:300;
	font-size:9pt;
	border:.5pt solid #999999;
	vertical-align:middle;
	text-align:left;
	font-family:'$primaryFont',sans-serif;
	padding:.5pt 1pt .5pt 1pt;
	margin:0;
}
#if( $format == 'pdf') /*no named pages w/ .pdf*/
@page {
	size:11.0in 8.5in;
}
#end 
#if( $format != 'pdf') 
@page SectionLandscape {
	size:11.0in 8.5in;
	margin:.5in .5in .5in .5in;
}
div.SectionLandscape {
	page: SectionLandscape;
	margin:.5in .5in .5in .5in;
}
#end

</style>
</head>
## =================================================================================================================
##
##
## MACROS 
##
##
## =================================================================================================================
#########################################################################################################################
##          Macro: getDateTime
##          Input: Java Time Zone ID to determine which timezone to display the date in
##          Output: Formatted date in the desired timezone
#########################################################################################################################
#macro( getDateTime $inputDate $inputTimeZone )
  #set( $outTz = $dateTool.getTimeZone().getTimeZone($inputTimeZone) )
  #set( $locale = $dateTool.getLocale() )
  #set( $dateTime = $dateTool.format( 'MM/dd/yyyy hh:mm a', $inputDate, $locale, $outTz ))
  $!dateTime
#end
#########################################################################################################################
######################################################################################################################
## 
##      getLicenseType 
##      Input: $userLicenseType - enum code of user license type 
##      Output: $userLicenseDisplay - display name of license type 
## 
######################################################################################################################
#macro( getLicenseType $userLicenseType )

  #if( $userLicenseType == "N")
    #set( $userLicenseDisplay = "Creator")
  #elseif( $userLicenseType == "C")
    #set( $userLicenseDisplay = "Creator (Float)")
  #elseif( $userLicenseType == "S")
    #set( $userLicenseDisplay = "Stakeholder")
  #elseif( $userLicenseType == "FC")
    #set( $userLicenseDisplay = "Collaborator (Float)")
  #elseif( $userLicenseType == "R")
    #set( $userLicenseDisplay = "Collaborator (Reserved)")
  #elseif( $userLicenseType == "V")
    #set( $userLicenseDisplay = "Reviewer (Float)")
  #elseif( $userLicenseType == "RV")
    #set( $userLicenseDisplay = "Reviewer (Reserved)")
  #elseif( $userLicenseType == "NV")
    #set( $userLicenseDisplay = "Reviewer")
  #elseif( $userLicenseType == "ET")
    #set( $userLicenseDisplay = "Expiring Trial")
  #elseif( $userLicenseType == "I")
    #set( $userLicenseDisplay = "Inactive")
  #elseif( $userLicenseType == "TR")
    #set( $userLicenseDisplay = "Test runner")
  #end 

  ##$userLicenseDisplay

#end 
##
######################################################################################################################
##  
##      groupLicensesPerUser
##      Input: $userLicenseUsage
##      Output: $userLicensesWithUsageLast6Months 
## 
######################################################################################################################
######################################################################################################################
#macro( groupLicensesPerUser $userLicenseUsage )

  #foreach( $activity in $userLicenseUsage ) 
    #set( $user = $activity.get("user"))
    #set( $userID = $user.id)
    #set( $license = $activity.get("license"))

    #if( $foreach.hasNext )
      #set( $nextIndex = $foreach.index + 1 )
      #set( $nextItem = $userLicenseUsage.get($nextIndex))
      #set( $nextItemID = $nextItem.get("userId"))
    #else
      #set( $nextItem = false )
    #end

  	#if( !$licenses.contains( $license ))
  		#set( $success = $licenses.add($license))
  	#end 

    #if( $userID != $nextItemID || !$nextItem ) 
       #set( $success = $userLicensesWithUsageLast6Months.add({ "user": $user, "licenses": $licenses }))
       #set( $licenses = [] )
    #end

  #end 
#end 
##
######################################################################################################################
######################################################################################################################
## ===================================================================================================================
##
##
## REPORT BODY
##
##
## ===================================================================================================================
##-----------------## 
##  Get User Data  ## 
##-----------------## 
#set( $licenses = [] )
#set( $userLicenseUsage = [] )
#set( $userLicensesWithUsageLast6Months = [] )
#set( $usersInOrg = $userSource.getActiveUserListByOrgId($project.organizationId)) ## This returned an inactive user
#set( $usageForLastSixMonths = $userSource.getLoginsForLastHours(4380, $project.organizationId))

#foreach( $activity in $usageForLastSixMonths ) 
  #set( $user = $activity.user )
  #set( $userId = $user.id )
  #set( $license = $activity.actualLicenseType)
  #getLicenseType($license)
  #set( $licenseDisplay = "${license} - ${userLicenseDisplay}")
  #set( $success = $userLicenseUsage.add({ "userId":$userId, "user": $user, "license": $licenseDisplay }))
#end 

#set( $userLicenseUsage = $sortTool.sort( $userLicenseUsage,"userId:asc" ))
#groupLicensesPerUser( $userLicenseUsage ) ## Returns $userLicensesWithUsageLast6Months
<body>
	<div class=SectionLandscape>
		<table style='width:100%;table-layout:fixed;'>
## ===================================================================================================================
##
##
## 		TABLE COL Definitions & HEADINGS
##
##
## ===================================================================================================================
			<colgroup>
				<col style='width:100pt'/>
				<col style='width:100pt'/>
				<col style='width:145pt'/>
				<col style='width:158pt'/>
				<col style='width:145pt'/>
			</colgroup>
			<thead>
				<tr>
					<td class=title colspan=2 style='text-align:left;border:none;font-size:11pt'>$project.organization.name</td>
					<td class=title colspan=2 rowspan=2 style='text-align:center;border:none;'>JAMA USER LIST</td>
					<td class=cell style='text-align:right;border:none;'>#getDateTime($dateTool.date, $timeZone)</td>
				</tr>
				<tr> 
					<td class=cell colspan=2 style='text-align:left;border:none;'>Report Runner: $userSource.currentUser.fullName</td>
					<td class=cell style='text-align:left;border:none;'></td>
				</tr>
				<tr>
					<td class=header width='100pt'>Username</td>
					<td class=header width='100pt'>Full Name</td>
					<td class=header width='145pt'>Email</td>
					<td class=header width='158pt'>Groups</td>
					<td class=header width='145pt'>License Type*</td>
				</tr>
			</thead>

			<tbody>
## ===================================================================================================================
##
##
## 		DYNAMIC ROWS, One row per active user
##
##
## ===================================================================================================================
			#foreach( $userInOrg in $usersInOrg )
				#set( $licenses = [])
				#set( $groups = [] )
				#foreach( $group in $userInOrg.roles )
					#if( !$groups.contains($group.display))
						#set( $success = $groups.add( $group.display))
					#end 
				#end
				<tr>
					<td class=cell width='100pt'>$userInOrg.userName</td>
					<td class=cell width='100pt'>$userInOrg.fullName</td>
					<td class=cell width='145pt'>$userInOrg.email</td>
					<td class=cell width='158pt'>#foreach( $group in $groups ) #if( !$foreach.last)$group, #else $group #end #end</td>
					#foreach( $u in $userLicensesWithUsageLast6Months )
						#set( $user = $u.get("user"))
						#if( $userInOrg.id == $user.id )
							#set( $licenses = $u.get("licenses"))
							#break
						#end 
					#end
					<td class=cell width='145pt'>#if($licenses.size() == 0) No license usage last 6 months #else #foreach( $license in $licenses ) #if( !$foreach.last)$!license, #else $!license #end #end #end</td>
				</tr>
			#end
			<tr>
				<td colspan=5 class=cell style='text-align:left;border:none;'>*Shows licenses for users that have logged in within the last 6 months from the date the report was run. If the user has not logged in within the last 6 months it will show 'No license usage last 6 months'.</td>
			</tr>
			</tbody>
		</table>
	</div>
</body>
</html>